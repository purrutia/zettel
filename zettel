#!/usr/bin/sh

# zettel: creates a new zettel on Zettelkasten repository

ZETTAG=$(utctag)
REPOSDIR="${HOME}/repos/github.com/${USER}"
ZETTELKASTENDIR="${REPOSDIR}/zettelkasten/"

usage() {
    printf "\nusage:\n\n"
    printf "Creates a new zettel for the Zettelkasten:\n"
    printf "zettel <zettel Title>\n\n"
    printf "Displays this help:\n"
    printf "zettel -h\n\n"
}

main() {

    # Checks if the zettel has the Title
    test ! -n "${1}" && usage && exit 1
    if test "${1}" = "-h"; then
        usage
    else
        ZETTELTITLE=$@
        case $ZETTELTITLE in
            (*[!abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZáéíóúÁÉÍÓÚ1234567890_:.[:blank:]-]*)
                echo >&2 "Zettel Title includes NOT allowed characters" && exit 1;;
            (*)
                cd "${ZETTELKASTENDIR}" || exit
                touch "${ZETTAG}.md"
                {
                    echo "# ${ZETTELTITLE} -- ${ZETTAG}" 
                } >> "${ZETTAG}.md"
                ${EDITOR} "${ZETTAG}.md" && echo "- [${ZETTAG}](${ZETTAG}.md) -- ${ZETTELTITLE}" >> index.md && git add "${ZETTAG}.md" "index.md" && git commit -m "${ZETTAG} -- ${ZETTELTITLE}"
                ;;
        esac
    fi
}

main $@
